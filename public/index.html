<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Job Application Tracker</title>
  <style>
    /* === Reset & Variables === */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --color-bg: #ffffff;
      --color-bg-alt: #f4f7f5;
      --color-text: #1a2e1a;
      --color-text-secondary: #5a6e5a;
      --color-border: #d4ddd7;
      --color-primary: #1b3a2a;
      --color-primary-hover: #264d38;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

      /* Status colours */
      --status-applied: #2e7d32;
      --status-applied-bg: #e8f5e9;
      --status-want: #1565c0;
      --status-want-bg: #e3f2fd;
      --status-interview: #ef6c00;
      --status-interview-bg: #fff3e0;
      --status-offered: #6a1b9a;
      --status-offered-bg: #f3e5f5;
      --status-rejected: #c62828;
      --status-rejected-bg: #ffebee;
      --status-no-response: #616161;
      --status-no-response-bg: #f5f5f5;

      /* IR35 colours */
      --ir35-outside: #2e7d32;
      --ir35-outside-bg: #e8f5e9;
      --ir35-inside: #ef6c00;
      --ir35-inside-bg: #fff3e0;

      --radius: 8px;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* === Base === */
    body {
      font-family: var(--font);
      background: var(--color-bg-alt);
      color: var(--color-text);
      line-height: 1.6;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* === Header === */
    header {
      background: var(--color-primary);
      color: #fff;
      padding: 24px 24px 20px;
    }

    .header-inner {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    header h1 {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .job-count {
      font-size: 0.85rem;
      opacity: 0.8;
      margin-left: 12px;
    }

    .btn-add {
      display: inline-block;
      padding: 10px 20px;
      background: #fff;
      color: var(--color-primary);
      border: none;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font);
      transition: background 0.2s, transform 0.15s;
    }

    .btn-add:hover {
      background: #f0f0f0;
      transform: translateY(-1px);
    }

    /* === Main Content === */
    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 24px 60px;
    }

    /* === Filter Bar === */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 16px;
    }

    .filter-btn {
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      padding: 7px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      color: var(--color-text-secondary);
      font-weight: 500;
      transition: all 0.2s;
      font-family: var(--font);
    }

    .filter-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .filter-btn.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    /* === Controls Row (search, sort, view toggle) === */
    .controls-row {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-family: var(--font);
      background: var(--color-bg);
      color: var(--color-text);
      outline: none;
      transition: border-color 0.2s;
    }

    .search-box:focus {
      border-color: var(--color-primary);
    }

    .search-box::placeholder {
      color: #aaa;
    }

    .sort-select {
      padding: 10px 14px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-family: var(--font);
      background: var(--color-bg);
      cursor: pointer;
      color: var(--color-text);
      outline: none;
      transition: border-color 0.2s;
    }

    .sort-select:focus {
      border-color: var(--color-primary);
    }

    /* === View Toggle === */
    .view-toggle {
      display: flex;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .view-btn {
      padding: 10px 14px;
      background: var(--color-bg);
      border: none;
      cursor: pointer;
      font-family: var(--font);
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .view-btn + .view-btn {
      border-left: 1px solid var(--color-border);
    }

    .view-btn:hover {
      background: var(--color-bg-alt);
    }

    .view-btn.active {
      background: var(--color-primary);
      color: #fff;
    }

    /* Small icons for the view toggle buttons */
    .view-icon {
      font-size: 1rem;
      line-height: 1;
    }

    /* === Job Cards (Card View) === */
    .cards-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .cards-container.view-cards {
      grid-template-columns: 1fr;
    }

    .job-card {
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s;
    }

    .job-card:hover {
      box-shadow: var(--shadow-md);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .card-company {
      font-size: 0.95rem;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    .card-recruiter {
      font-size: 0.82rem;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    /* === Status & IR35 Badges === */
    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge-applied {
      background: var(--status-applied-bg);
      color: var(--status-applied);
    }

    .badge-want-to-apply {
      background: var(--status-want-bg);
      color: var(--status-want);
    }

    .badge-interview {
      background: var(--status-interview-bg);
      color: var(--status-interview);
    }

    .badge-offered {
      background: var(--status-offered-bg);
      color: var(--status-offered);
    }

    .badge-rejected {
      background: var(--status-rejected-bg);
      color: var(--status-rejected);
    }

    .badge-no-response {
      background: var(--status-no-response-bg);
      color: var(--status-no-response);
    }

    .badge-ir35-outside {
      background: var(--ir35-outside-bg);
      color: var(--ir35-outside);
    }

    .badge-ir35-inside {
      background: var(--ir35-inside-bg);
      color: var(--ir35-inside);
    }

    /* Job type badges (Permanent vs Contract) */
    .badge-permanent {
      background: #ede7f6;
      color: #5e35b1;
    }

    .badge-contract {
      background: #e0f2f1;
      color: #00796b;
    }

    /* === Star / Favourite Button === */
    .btn-star {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.3rem;
      line-height: 1;
      padding: 0;
      color: #ccc;
      transition: color 0.2s, transform 0.15s;
      flex-shrink: 0;
    }

    .btn-star:hover {
      transform: scale(1.2);
    }

    .btn-star.starred {
      color: #f5a623;
    }

    /* === Card Details === */
    .card-details {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 18px;
      margin: 10px 0;
      font-size: 0.88rem;
      color: var(--color-text-secondary);
    }

    .card-detail {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .card-detail-label {
      font-weight: 600;
      color: var(--color-text);
      font-size: 0.8rem;
    }

    .card-notes {
      font-size: 0.88rem;
      color: var(--color-text-secondary);
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--color-border);
    }

    .card-notes-label {
      font-weight: 600;
      color: var(--color-text);
      font-size: 0.8rem;
    }

    .card-link {
      display: inline-block;
      margin-top: 8px;
      font-size: 0.85rem;
      color: var(--color-primary);
      text-decoration: none;
    }

    .card-link:hover {
      text-decoration: underline;
    }

    /* === Card Actions === */
    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--color-border);
    }

    .btn-edit, .btn-delete {
      padding: 6px 14px;
      border-radius: var(--radius);
      font-size: 0.82rem;
      cursor: pointer;
      font-family: var(--font);
      font-weight: 500;
      border: 1px solid var(--color-border);
      transition: all 0.2s;
    }

    .btn-edit {
      background: transparent;
      color: var(--color-text);
    }

    .btn-edit:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .btn-delete {
      background: transparent;
      color: var(--color-text-secondary);
    }

    .btn-delete:hover {
      border-color: var(--status-rejected);
      color: var(--status-rejected);
    }

    /* === List View === */
    .cards-container.view-list {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .cards-container.view-list .job-card {
      display: none;
    }

    .list-row {
      display: none;
    }

    .cards-container.view-list .list-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-bottom: none;
      font-size: 0.88rem;
      transition: background 0.15s;
    }

    .cards-container.view-list .list-row:first-child {
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .cards-container.view-list .list-row:last-child {
      border-bottom: 1px solid var(--color-border);
      border-radius: 0 0 var(--radius) var(--radius);
    }

    .cards-container.view-list .list-row:only-child {
      border-radius: var(--radius);
      border-bottom: 1px solid var(--color-border);
    }

    .cards-container.view-list .list-row:hover {
      background: var(--color-bg-alt);
    }

    .list-title {
      font-weight: 600;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-company {
      color: var(--color-text-secondary);
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-rate {
      white-space: nowrap;
      font-weight: 500;
    }

    .list-location {
      color: var(--color-text-secondary);
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .list-badges {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .list-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }

    .list-actions .btn-edit,
    .list-actions .btn-delete {
      padding: 4px 10px;
      font-size: 0.78rem;
    }

    /* === Empty State === */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--color-text-secondary);
    }

    .empty-state p {
      font-size: 1rem;
      margin-bottom: 6px;
    }

    .empty-state .empty-hint {
      font-size: 0.88rem;
    }

    /* === Modal Overlay === */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--color-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 28px;
    }

    .modal h2 {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 20px;
    }

    /* === Form === */
    .form-group {
      margin-bottom: 14px;
    }

    .form-group label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 4px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-family: var(--font);
      color: var(--color-text);
      background: var(--color-bg);
      outline: none;
      transition: border-color 0.2s;
      resize: vertical;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      border-color: var(--color-primary);
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: #aaa;
    }

    .form-group textarea {
      height: 80px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-save {
      display: inline-block;
      padding: 10px 24px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font);
      transition: background 0.2s;
    }

    .btn-save:hover {
      background: var(--color-primary-hover);
    }

    .btn-cancel {
      display: inline-block;
      padding: 10px 20px;
      background: transparent;
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      cursor: pointer;
      font-family: var(--font);
      transition: all 0.2s;
    }

    .btn-cancel:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    /* === Confirm Dialog === */
    .confirm-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .confirm-overlay.open {
      display: flex;
    }

    .confirm-box {
      background: var(--color-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      padding: 28px;
      max-width: 400px;
      width: 100%;
    }

    .confirm-box p {
      margin-bottom: 20px;
      font-size: 0.95rem;
      line-height: 1.6;
    }

    .confirm-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .btn-confirm-delete {
      display: inline-block;
      padding: 10px 20px;
      background: var(--status-rejected);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font);
      transition: background 0.2s;
    }

    .btn-confirm-delete:hover {
      background: #b71c1c;
    }

    .btn-confirm-cancel {
      display: inline-block;
      padding: 10px 20px;
      background: transparent;
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      cursor: pointer;
      font-family: var(--font);
      transition: all 0.2s;
    }

    .btn-confirm-cancel:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    /* === Footer === */
    footer {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px 24px;
      text-align: center;
    }

    footer p {
      color: var(--color-text-secondary);
      font-size: 0.8rem;
    }

    /* === Responsive === */

    /* Two-column cards on wider screens */
    @media (min-width: 700px) {
      .cards-container.view-cards {
        grid-template-columns: 1fr 1fr;
      }
    }

    /* Mobile */
    @media (max-width: 640px) {
      header {
        padding: 18px 16px;
      }

      .header-inner {
        gap: 10px;
      }

      header h1 {
        font-size: 1.15rem;
      }

      main {
        padding: 16px 16px 48px;
      }

      .cards-container.view-cards {
        grid-template-columns: 1fr;
      }

      .job-card {
        padding: 16px;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .modal {
        padding: 20px;
      }

      .card-details {
        flex-direction: column;
        gap: 4px;
      }

      /* Larger touch targets on mobile */
      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px 14px;
        font-size: 1rem;
      }

      .filter-btn {
        padding: 8px 14px;
      }

      /* Stack list rows on mobile for readability */
      .cards-container.view-list .list-row {
        flex-wrap: wrap;
        gap: 6px;
      }

      .list-info {
        flex-wrap: wrap;
        gap: 6px;
      }

      .list-location {
        display: none;
      }
    }

    /* Small phones */
    @media (max-width: 400px) {
      header {
        padding: 14px 12px;
      }

      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }

      .btn-add {
        width: 100%;
        text-align: center;
      }

      main {
        padding: 12px 12px 40px;
      }
    }

    /* === Header Buttons === */
    .header-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .sync-status {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 2px;
    }

    .sync-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: var(--color-primary);
      color: #fff;
      padding: 14px 28px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-family: var(--font);
      z-index: 3000;
      box-shadow: var(--shadow-md);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
      pointer-events: none;
      max-width: 90vw;
      text-align: center;
    }

    .sync-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* === Stats Dashboard === */
    .stats-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0;
      margin-bottom: 20px;
      padding: 20px;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .stat-item {
      text-align: center;
      flex: 1;
      min-width: 80px;
      padding: 0 16px;
    }

    .stat-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--color-primary);
      line-height: 1.2;
    }

    .stat-label {
      font-size: 0.78rem;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    .stat-divider {
      width: 1px;
      background: var(--color-border);
      align-self: stretch;
    }

    .pipeline-section {
      width: 100%;
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--color-border);
    }

    .pipeline-bar {
      display: flex;
      height: 8px;
      border-radius: 4px;
      overflow: hidden;
      background: #eee;
    }

    .pipeline-segment {
      transition: width 0.3s ease;
      min-width: 0;
    }

    .pipeline-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--color-text-secondary);
    }

    .pipeline-legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pipeline-legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .stats-follow-up-alert {
      width: 100%;
      margin-top: 10px;
      padding: 8px 12px;
      background: #fff8e1;
      border-radius: var(--radius);
      font-size: 0.82rem;
      color: #f57f17;
      font-weight: 500;
    }

    @media (max-width: 640px) {
      .stats-bar {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .stat-divider { display: none; }
      .pipeline-section, .stats-follow-up-alert {
        grid-column: 1 / -1;
      }
    }

    /* === Interview Fields (in form) === */
    .interview-fields {
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px dashed var(--color-border);
      display: none;
    }

    .interview-fields.visible {
      display: block;
    }

    .interview-fields label {
      border-left: 3px solid var(--status-interview);
      padding-left: 8px;
    }

    /* Interview info displayed on cards */
    .interview-info {
      background: var(--status-interview-bg);
      border-radius: var(--radius);
      padding: 10px 12px;
      margin-top: 8px;
      font-size: 0.85rem;
      line-height: 1.7;
    }

    .interview-info-label {
      font-weight: 600;
      color: var(--status-interview);
      font-size: 0.8rem;
    }

    .interview-countdown {
      font-weight: 600;
      color: var(--status-interview);
    }

    /* === Follow-up Reminders === */
    .follow-up-warning {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 0.82rem;
      font-weight: 500;
    }

    .follow-up-nudge {
      background: #fff8e1;
      color: #f57f17;
    }

    .follow-up-overdue {
      background: #ffebee;
      color: var(--status-rejected);
    }

    .follow-up-icon {
      font-size: 1rem;
      flex-shrink: 0;
    }

    /* === Job Feed Section === */
    .feed-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid var(--color-border);
    }

    .feed-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .feed-header h2 {
      font-size: 1.15rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feed-count {
      background: var(--color-primary);
      color: #fff;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
    }

    .feed-meta {
      font-size: 0.8rem;
      color: var(--color-text-secondary);
    }

    .feed-cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 700px) {
      .feed-cards {
        grid-template-columns: 1fr 1fr;
      }
    }

    .feed-card {
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .feed-card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .feed-card-company {
      font-size: 0.9rem;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    .feed-card-details {
      display: flex;
      flex-wrap: wrap;
      gap: 4px 14px;
      margin: 8px 0;
      font-size: 0.85rem;
      color: var(--color-text-secondary);
    }

    .feed-card-desc {
      font-size: 0.82rem;
      color: var(--color-text-secondary);
      margin: 8px 0;
      line-height: 1.5;
    }

    .feed-source {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .feed-source-reed {
      background: #e3f2fd;
      color: #1565c0;
    }

    .feed-source-adzuna {
      background: #fce4ec;
      color: #c62828;
    }

    .feed-source-jooble {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .feed-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid var(--color-border);
    }

    .btn-track {
      padding: 6px 14px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font);
      transition: background 0.2s;
    }

    .btn-track:hover {
      background: var(--color-primary-hover);
    }

    .btn-dismiss {
      padding: 6px 14px;
      background: transparent;
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.82rem;
      cursor: pointer;
      font-family: var(--font);
      transition: all 0.2s;
    }

    .btn-dismiss:hover {
      border-color: var(--status-rejected);
      color: var(--status-rejected);
    }

    .feed-empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--color-text-secondary);
      font-size: 0.9rem;
      grid-column: 1 / -1;
    }

    .btn-refresh-feed {
      padding: 6px 14px;
      background: transparent;
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.82rem;
      cursor: pointer;
      font-family: var(--font);
      transition: all 0.2s;
    }

    .btn-refresh-feed:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    /* === Login Screen === */
    #loginScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--color-bg-alt);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-box {
      background: var(--color-bg);
      padding: 40px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      text-align: center;
      max-width: 360px;
      width: 90%;
    }

    .login-box h2 {
      color: var(--color-primary);
      margin-bottom: 8px;
      font-size: 1.4rem;
    }

    .login-box p {
      color: var(--color-text-secondary);
      margin-bottom: 24px;
      font-size: 0.9rem;
    }

    .login-box input[type="password"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 1rem;
      font-family: var(--font);
      margin-bottom: 12px;
    }

    .login-box input[type="password"]:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(27, 58, 42, 0.1);
    }

    .login-box button[type="submit"] {
      width: 100%;
      padding: 12px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font);
      transition: background 0.2s;
    }

    .login-box button[type="submit"]:hover {
      background: var(--color-primary-hover);
    }

    .login-error {
      color: var(--status-rejected);
      font-size: 0.85rem;
      margin-top: 12px;
      min-height: 20px;
    }

    /* Hide the app content until authenticated */
    .app-hidden header,
    .app-hidden main,
    .app-hidden footer { display: none; }

    /* === Page Navigation Tabs === */
    .page-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 20px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      overflow: hidden;
      background: var(--color-bg);
    }

    .page-tab {
      flex: 1;
      padding: 12px 16px;
      background: var(--color-bg);
      border: none;
      cursor: pointer;
      font-family: var(--font);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--color-text-secondary);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .page-tab + .page-tab {
      border-left: 1px solid var(--color-border);
    }

    .page-tab:hover {
      background: var(--color-bg-alt);
    }

    .page-tab.active {
      background: var(--color-primary);
      color: #fff;
    }

    .page-tab-count {
      font-size: 0.75rem;
      padding: 1px 7px;
      border-radius: 12px;
      font-weight: 600;
    }

    .page-tab.active .page-tab-count {
      background: rgba(255, 255, 255, 0.2);
    }

    .page-tab:not(.active) .page-tab-count {
      background: rgba(0, 0, 0, 0.08);
    }

    /* === Recruiter Status Colours === */
    :root {
      --rec-status-not-contacted: #7b1fa2;
      --rec-status-not-contacted-bg: #f3e5f5;
      --rec-status-reached: #1565c0;
      --rec-status-reached-bg: #e3f2fd;
      --rec-status-active: #2e7d32;
      --rec-status-active-bg: #e8f5e9;
      --rec-status-quiet: #ef6c00;
      --rec-status-quiet-bg: #fff3e0;
      --rec-status-not-useful: #616161;
      --rec-status-not-useful-bg: #f5f5f5;

      --role-mentioned: #616161;
      --role-mentioned-bg: #f5f5f5;
      --role-cv: #1565c0;
      --role-cv-bg: #e3f2fd;
      --role-interview: #6a1b9a;
      --role-interview-bg: #f3e5f5;
      --role-rejected: #c62828;
      --role-rejected-bg: #ffebee;
      --role-withdrawn: #616161;
      --role-withdrawn-bg: #f5f5f5;
    }

    /* === Recruiters Panel === */
    .recruiters-panel {
      display: none;
    }

    .recruiters-panel.visible {
      display: block;
    }

    /* === Add Recruiter Form === */
    .rec-form {
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .rec-form-row {
      display: flex;
      gap: 10px;
    }

    .rec-form-row input[type="text"] {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      font-family: var(--font);
      background: var(--color-bg);
      color: var(--color-text);
      outline: none;
      transition: border-color 0.2s;
    }

    .rec-form-row input[type="text"]:focus {
      border-color: var(--color-primary);
    }

    .rec-form-row input[type="text"]::placeholder {
      color: #aaa;
    }

    .rec-form-options {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .rec-form-options .form-group {
      margin-bottom: 0;
    }

    .rec-form-options input,
    .rec-form-options select {
      padding: 8px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.85rem;
      font-family: var(--font);
      color: var(--color-text);
      background: var(--color-bg);
      outline: none;
    }

    .rec-form-options input:focus,
    .rec-form-options select:focus {
      border-color: var(--color-primary);
    }

    .rec-form-options label {
      font-size: 0.78rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    /* === Recruiter Cards === */
    .rec-list {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .rec-card {
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 12px;
      overflow: hidden;
      transition: box-shadow 0.2s;
    }

    .rec-card:hover {
      box-shadow: var(--shadow-md);
    }

    .rec-summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      cursor: pointer;
      transition: background 0.15s;
      gap: 12px;
    }

    .rec-summary:hover {
      background: var(--color-bg-alt);
    }

    .rec-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      flex: 1;
    }

    .rec-company {
      font-size: 1rem;
      font-weight: 600;
      word-break: break-word;
    }

    .rec-contact-name {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
    }

    .rec-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .rec-date {
      font-size: 0.78rem;
      color: var(--color-text-secondary);
    }

    /* === Recruiter Status Badges === */
    .rec-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.72rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .rec-badge-not-contacted { background: var(--rec-status-not-contacted-bg); color: var(--rec-status-not-contacted); }
    .rec-badge-reached-out { background: var(--rec-status-reached-bg); color: var(--rec-status-reached); }
    .rec-badge-active { background: var(--rec-status-active-bg); color: var(--rec-status-active); }
    .rec-badge-quiet { background: var(--rec-status-quiet-bg); color: var(--rec-status-quiet); }
    .rec-badge-not-useful { background: var(--rec-status-not-useful-bg); color: var(--rec-status-not-useful); }

    /* === Role Status Badges === */
    .role-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .role-badge-mentioned { background: var(--role-mentioned-bg); color: var(--role-mentioned); }
    .role-badge-cv-submitted { background: var(--role-cv-bg); color: var(--role-cv); }
    .role-badge-interview { background: var(--role-interview-bg); color: var(--role-interview); }
    .role-badge-rejected { background: var(--role-rejected-bg); color: var(--role-rejected); }
    .role-badge-withdrawn { background: var(--role-withdrawn-bg); color: var(--role-withdrawn); }

    /* === Priority & Follow-up Flags === */
    .rec-flag {
      cursor: pointer;
      font-size: 1rem;
      color: #ccc;
      transition: color 0.2s, transform 0.15s;
      user-select: none;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }

    .rec-flag:hover {
      transform: scale(1.2);
    }

    .rec-flag.flag-active {
      color: #f5a623;
    }

    .rec-flag-followup.flag-active {
      color: var(--color-primary);
    }

    /* === Recruiter Detail (Expanded) === */
    .rec-detail {
      padding: 0 20px 20px;
      border-top: 1px solid var(--color-border);
    }

    .rec-detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 16px 0;
    }

    .rec-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .rec-field.full-width {
      grid-column: 1 / -1;
    }

    .rec-field label {
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    .rec-field input,
    .rec-field select,
    .rec-field textarea {
      padding: 8px 10px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 0.88rem;
      font-family: var(--font);
      color: var(--color-text);
      background: var(--color-bg);
      outline: none;
      transition: border-color 0.2s;
    }

    .rec-field input:focus,
    .rec-field select:focus,
    .rec-field textarea:focus {
      border-color: var(--color-primary);
    }

    .rec-field input::placeholder,
    .rec-field textarea::placeholder {
      color: #aaa;
    }

    .rec-field textarea {
      resize: vertical;
      min-height: 60px;
    }

    /* === Roles Section (inside expanded card) === */
    .rec-roles-section {
      border-top: 1px solid var(--color-border);
      padding-top: 16px;
      margin-top: 4px;
    }

    .rec-roles-header {
      font-size: 0.88rem;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rec-roles-count {
      font-size: 0.72rem;
      font-weight: 600;
      padding: 1px 7px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.08);
    }

    .rec-roles-empty {
      font-size: 0.85rem;
      color: var(--color-text-secondary);
      padding: 8px 0;
      font-style: italic;
    }

    .rec-role-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: var(--color-bg-alt);
      border-radius: 6px;
      margin-bottom: 8px;
      gap: 10px;
      font-size: 0.88rem;
    }

    .rec-role-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .rec-role-title {
      font-weight: 500;
      word-break: break-word;
    }

    .rec-role-company {
      font-size: 0.8rem;
      color: var(--color-text-secondary);
    }

    .rec-role-date {
      font-size: 0.78rem;
      color: var(--color-text-secondary);
    }

    .rec-role-comment {
      font-size: 0.78rem;
      color: var(--color-text-secondary);
      font-style: italic;
      margin-top: 2px;
    }

    .rec-role-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }

    .rec-role-delete {
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 1rem;
      padding: 4px;
      transition: color 0.2s;
      flex-shrink: 0;
    }

    .rec-role-delete:hover {
      color: var(--status-rejected);
    }

    /* === Add Role Form === */
    .rec-role-form {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .rec-role-form input,
    .rec-role-form select {
      padding: 7px 10px;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      font-size: 0.82rem;
      font-family: var(--font);
      color: var(--color-text);
      background: var(--color-bg);
      outline: none;
      transition: border-color 0.2s;
    }

    .rec-role-form input:focus,
    .rec-role-form select:focus {
      border-color: var(--color-primary);
    }

    .rec-role-form input::placeholder {
      color: #aaa;
    }

    .rec-role-form input[type="text"] {
      flex: 1;
      min-width: 120px;
    }

    .btn-add-role {
      padding: 7px 14px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      font-family: var(--font);
      transition: background 0.2s;
    }

    .btn-add-role:hover {
      background: var(--color-primary-hover);
    }

    /* === Recruiter Actions & Footer === */
    .rec-actions {
      padding-top: 12px;
      border-top: 1px solid var(--color-border);
      margin-top: 16px;
      text-align: right;
    }

    .btn-delete-rec {
      padding: 6px 14px;
      background: transparent;
      color: var(--color-text-secondary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 0.82rem;
      cursor: pointer;
      font-family: var(--font);
      transition: all 0.2s;
    }

    .btn-delete-rec:hover {
      border-color: var(--status-rejected);
      color: var(--status-rejected);
    }

    .rec-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      font-size: 0.85rem;
      color: var(--color-text-secondary);
    }

    .rec-empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--color-text-secondary);
    }

    .rec-empty-state p {
      font-size: 1rem;
      margin-bottom: 6px;
    }

    .rec-empty-state .empty-hint {
      font-size: 0.88rem;
    }

    /* === Recruiter Responsive === */
    @media (max-width: 640px) {
      .rec-form-options {
        flex-direction: column;
        gap: 10px;
      }

      .rec-summary {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .rec-detail-grid {
        grid-template-columns: 1fr;
      }

      .rec-role-form {
        flex-direction: column;
      }

      .rec-role-form input[type="text"] {
        min-width: auto;
      }

      .rec-role-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .rec-role-meta {
        flex-wrap: wrap;
      }

      .page-tab {
        font-size: 0.82rem;
        padding: 10px 12px;
      }
    }
  </style>
</head>
<body class="app-hidden">

  <!-- Login Screen (shown when not authenticated) -->
  <div id="loginScreen">
    <div class="login-box">
      <h2>Job Tracker</h2>
      <p>Enter the password to continue</p>
      <form id="loginForm">
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" required>
        <button type="submit">Sign In</button>
        <p class="login-error" id="loginError"></p>
      </form>
    </div>
  </div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div>
        <h1>Job Application Tracker <span class="job-count" id="jobCount">0 applications</span></h1>
        <div class="sync-status" id="syncStatus"></div>
      </div>
      <div class="header-buttons">
        <a href="/interview-prep.html" class="btn-add" style="text-decoration:none">Interview Prep</a>
        <button class="btn-add" id="btnAdd">+ Add New Job</button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- Page Tabs: Jobs vs Recruiters -->
    <nav class="page-tabs" id="pageTabs">
      <button class="page-tab active" data-page="jobs">
        Jobs <span class="page-tab-count" id="jobsTabCount">0</span>
      </button>
      <button class="page-tab" data-page="recruiters">
        Recruiters <span class="page-tab-count" id="recruitersTabCount">0</span>
      </button>
    </nav>

    <!-- === JOBS VIEW (shown by default) === -->
    <div id="jobsView">
    <!-- Stats Dashboard -->
    <section class="stats-bar" id="statsBar"></section>

    <!-- Filter Buttons -->
    <nav class="filter-bar" id="filterBar">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="applied">Applied</button>
      <button class="filter-btn" data-filter="want-to-apply">Want to Apply</button>
      <button class="filter-btn" data-filter="interview">Interview</button>
      <button class="filter-btn" data-filter="offered">Offered</button>
      <button class="filter-btn" data-filter="rejected">Rejected</button>
      <button class="filter-btn" data-filter="no-response">No Response</button>
    </nav>

    <!-- Search, Sort & View Toggle -->
    <div class="controls-row">
      <input type="text" class="search-box" id="searchBox" placeholder="Search by job title, company, or recruiter...">
      <select class="sort-select" id="sortSelect">
        <option value="newest">Newest first</option>
        <option value="oldest">Oldest first</option>
        <option value="starred">Starred first</option>
        <option value="company">Company A-Z</option>
        <option value="rate-high" selected>Highest rate first</option>
        <option value="type">Job type</option>
      </select>
      <!-- View toggle: Cards or List -->
      <div class="view-toggle">
        <button class="view-btn active" data-view="cards" title="Card view">
          <span class="view-icon">&#9638;</span> Cards
        </button>
        <button class="view-btn" data-view="list" title="List view">
          <span class="view-icon">&#9776;</span> List
        </button>
      </div>
    </div>

    <!-- Job Cards / List -->
    <section class="cards-container view-cards" id="cardsContainer"></section>

    <!-- Job Feed (auto-discovered jobs from Reed and Adzuna) -->
    <section class="feed-section" id="feedSection">
      <div class="feed-header">
        <h2>
          Job Feed
          <span class="feed-count" id="feedCount">0</span>
        </h2>
        <div style="display:flex;align-items:center;gap:12px">
          <span class="feed-meta" id="feedMeta">Loading feed...</span>
          <button class="btn-refresh-feed" id="btnRefreshFeed" title="Reload feed from server">Refresh</button>
        </div>
      </div>
      <div class="feed-cards" id="feedCards"></div>
    </section>
    </div><!-- end jobsView -->

    <!-- === RECRUITERS VIEW (hidden by default) === -->
    <div class="recruiters-panel" id="recruitersPanel">
      <!-- Add Recruiter Form -->
      <div class="rec-form">
        <form id="recAddForm">
          <div class="rec-form-row">
            <input type="text" id="recCompanyInput" placeholder="Company or agency name..." autocomplete="off" required>
            <button type="submit" class="btn-add" style="padding:10px 20px">Add</button>
          </div>
          <div class="rec-form-options">
            <div class="form-group">
              <label for="recContactInput">Contact Name</label>
              <input type="text" id="recContactInput" placeholder="e.g. John Smith" autocomplete="off">
            </div>
            <div class="form-group">
              <label for="recStatusInput">Status</label>
              <select id="recStatusInput">
                <option value="not-contacted">Not Yet Contacted</option>
                <option value="reached-out">Reached Out</option>
                <option value="active">In Active Contact</option>
                <option value="quiet">Gone Quiet</option>
                <option value="not-useful">Not Useful</option>
              </select>
            </div>
          </div>
        </form>
      </div>

      <!-- Recruiter Cards List -->
      <div class="rec-list" id="recList"></div>

      <!-- Footer -->
      <div class="rec-footer" id="recFooter">
        <span id="recCount">0 recruiters</span>
      </div>
    </div><!-- end recruitersPanel -->

  </main>

  <!-- Footer -->
  <footer>
    <p>Your job applications are automatically saved and synced across all your devices.</p>
  </footer>

  <!-- Sync toast notification -->
  <div class="sync-toast" id="syncToast"></div>

  <!-- Add/Edit Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" role="dialog" aria-modal="true">
      <h2 id="modalTitle">Add New Job</h2>
      <form id="jobForm">
        <div class="form-group">
          <label for="fieldTitle">Job Title *</label>
          <input type="text" id="fieldTitle" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="fieldCompany">Company *</label>
            <input type="text" id="fieldCompany" required>
          </div>
          <div class="form-group">
            <label for="fieldRecruiter">Recruiter / Agency</label>
            <input type="text" id="fieldRecruiter">
          </div>
        </div>

        <div class="form-group">
          <label for="fieldLocation">Location</label>
          <input type="text" id="fieldLocation">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="fieldIR35">IR35 Status</label>
            <select id="fieldIR35">
              <option value="unspecified">Not specified</option>
              <option value="outside">Outside IR35</option>
              <option value="inside">Inside IR35</option>
            </select>
          </div>
          <div class="form-group">
            <label for="fieldRate">Day Rate (&pound;)</label>
            <input type="text" id="fieldRate" placeholder="e.g. 600 or 550-700">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="fieldJobType">Job Type</label>
            <select id="fieldJobType">
              <option value="contract">Contract</option>
              <option value="permanent">Permanent</option>
            </select>
          </div>
          <div class="form-group">
            <label for="fieldDuration">Duration</label>
            <input type="text" id="fieldDuration" placeholder="e.g. 6 months">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="fieldStatus">Status</label>
            <select id="fieldStatus">
              <option value="want-to-apply">Want to Apply</option>
              <option value="applied">Applied</option>
              <option value="interview">Interview</option>
              <option value="offered">Offered</option>
              <option value="rejected">Rejected</option>
              <option value="no-response">No Response</option>
            </select>
          </div>
        </div>

        <div class="form-group" id="dateGroup">
          <label for="fieldDate">Date Applied</label>
          <input type="date" id="fieldDate">
        </div>

        <!-- Interview-specific fields (only visible when status = Interview) -->
        <div class="interview-fields" id="interviewFields">
          <div class="form-row">
            <div class="form-group">
              <label for="fieldInterviewDate">Interview Date & Time</label>
              <input type="datetime-local" id="fieldInterviewDate">
            </div>
            <div class="form-group">
              <label for="fieldInterviewType">Interview Type</label>
              <select id="fieldInterviewType">
                <option value="">Not specified</option>
                <option value="phone">Phone call</option>
                <option value="video">Video call</option>
                <option value="in-person">In person</option>
                <option value="panel">Panel interview</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="fieldInterviewerName">Interviewer Name / Contact</label>
            <input type="text" id="fieldInterviewerName" placeholder="e.g. Sarah Jones, Hiring Manager">
          </div>
          <div class="form-group">
            <label for="fieldFollowUpDate">Follow-up Date</label>
            <input type="date" id="fieldFollowUpDate">
          </div>
          <div class="form-group">
            <label for="fieldInterviewNotes">Interview Notes / Feedback</label>
            <textarea id="fieldInterviewNotes" placeholder="How it went, what they asked, next steps..."></textarea>
          </div>
        </div>

        <div class="form-group">
          <label for="fieldLink">Link to Job Ad</label>
          <input type="url" id="fieldLink" placeholder="https://...">
        </div>

        <div class="form-group">
          <label for="fieldNotes">Notes</label>
          <textarea id="fieldNotes" placeholder="Any extra details..."></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" id="btnCancel">Cancel</button>
          <button type="submit" class="btn-save" id="btnSave">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Dialog -->
  <div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-box">
      <p id="confirmMessage">Are you sure you want to remove this job?</p>
      <div class="confirm-actions">
        <button class="btn-confirm-cancel" id="btnConfirmCancel">Cancel</button>
        <button class="btn-confirm-delete" id="btnConfirmDelete">Remove</button>
      </div>
    </div>
  </div>

  <script>
    /* === Authentication === */
    const AUTH_TOKEN_KEY = 'jobTracker_authToken';

    // Wrapper around fetch that adds the auth token to every API request
    function authFetch(url, options) {
      options = options || {};
      options.headers = options.headers || {};
      var token = localStorage.getItem(AUTH_TOKEN_KEY);
      if (token) {
        options.headers['Authorization'] = 'Bearer ' + token;
      }
      return fetch(url, options);
    }

    // Check if the user has a valid auth token on page load
    async function checkAuth() {
      var token = localStorage.getItem(AUTH_TOKEN_KEY);

      if (!token) {
        showLogin();
        return;
      }

      // Verify the token is still valid with the server
      try {
        var response = await fetch('/api/auth', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (response.ok) {
          hideLogin();
        } else {
          localStorage.removeItem(AUTH_TOKEN_KEY);
          showLogin();
        }
      } catch (err) {
        // Network error, but we have a token, so let the app try to load
        // (individual API calls will fail if truly offline)
        hideLogin();
      }
    }

    function showLogin() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.body.classList.add('app-hidden');
    }

    function hideLogin() {
      document.getElementById('loginScreen').style.display = 'none';
      document.body.classList.remove('app-hidden');
      initApp();
    }

    async function handleLogin(password) {
      var errorEl = document.getElementById('loginError');
      errorEl.textContent = '';

      try {
        var response = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: password })
        });

        if (response.ok) {
          var data = await response.json();
          localStorage.setItem(AUTH_TOKEN_KEY, data.token);
          hideLogin();
        } else {
          errorEl.textContent = 'Wrong password. Please try again.';
        }
      } catch (err) {
        errorEl.textContent = 'Connection error. Please try again.';
      }
    }

    // Called after successful authentication
    function initApp() {
      initJobs();
      loadFeed();
      initRecruiters();
    }

    /* === Constants === */
    const STORAGE_KEY = 'jobTracker_jobs';
    const SYNC_TS_KEY = 'jobTracker_lastModified';

    const STATUS_LABELS = {
      'want-to-apply': 'Want to Apply',
      'applied': 'Applied',
      'interview': 'Interview',
      'offered': 'Offered',
      'rejected': 'Rejected',
      'no-response': 'No Response'
    };

    const IR35_LABELS = {
      'outside': 'Outside IR35',
      'inside': 'Inside IR35',
      'unspecified': ''
    };

    const JOB_TYPE_LABELS = {
      'contract': 'Contract',
      'permanent': 'Permanent'
    };

    /* === Fallback data (used only if the database is empty, e.g. first ever load) === */
    const SEED_JOBS = [
      {"id":"seed-1","title":"Business Architect","company":"NineTech","recruiter":"Abigail Blaauw","location":"Remote (some London travel)","ir35":"outside","rate":"600","duration":"6 months","jobType":"contract","starred":false,"status":"applied","dateApplied":"2026-02-05","jobLink":"https://www.linkedin.com/jobs/view/4365797849/","notes":"No longer accepting applications","createdAt":"2026-02-05T10:00:00.000Z","updatedAt":"2026-02-05T10:00:00.000Z"},
      {"id":"seed-3","title":"AI Business Analyst (Applied AI)","company":"Lorien","recruiter":"","location":"London (Hybrid - 3 days/week)","ir35":"outside","rate":"","duration":"6 months","jobType":"contract","starred":false,"status":"applied","dateApplied":"2026-02-09","jobLink":"https://www.linkedin.com/jobs/view/4365101739/","notes":"Reports to Transformation Director. AI COE team. Translating business needs into build-ready requirements for applied AI (GenAI/LLMs, ML, automation).","createdAt":"2026-02-09T10:00:00.000Z","updatedAt":"2026-02-09T10:00:00.000Z"},
      {"id":"seed-4","title":"Business Architect (12-month FTC)","company":"Zurich","recruiter":"","location":"London (also Swindon, Fareham, Manchester, Birmingham, Glasgow)","ir35":"unspecified","rate":"~75,000/year","duration":"12 months","jobType":"permanent","starred":false,"status":"applied","dateApplied":"2026-02-09","jobLink":"https://talents.studysmarter.co.uk/companies/zurich-56-company-ltd/business-architect-12-month-fixed-term-contract-6868211/","notes":"Fixed-term contract (not contractor). 12% pension, annual bonus, private medical, 25 days holiday.","createdAt":"2026-02-09T12:00:00.000Z","updatedAt":"2026-02-09T12:00:00.000Z"},
      {"id":"seed-2","title":"Business Architect","company":"Credera","recruiter":"Sophie Socrates","location":"London","ir35":"inside","rate":"550-700","duration":"12 months","jobType":"contract","starred":false,"status":"applied","dateApplied":"2026-02-08","jobLink":"https://www.linkedin.com/jobs/view/4369929764/","notes":"","createdAt":"2026-02-08T10:00:00.000Z","updatedAt":"2026-02-08T10:00:00.000Z"},
      {"id":"seed-5","title":"Business Architect","company":"Entasis Partners","recruiter":"Tom Bending","location":"London Area (Hybrid)","ir35":"unspecified","rate":"75,000-100,000/year","duration":"Permanent","jobType":"permanent","starred":false,"status":"applied","dateApplied":"2026-02-09","jobLink":"https://www.linkedin.com/jobs/view/4361796440/","notes":"Permanent role (not contract). Salary 75k-100k + bonus + benefits. Hybrid working.","createdAt":"2026-02-09T18:00:00.000Z","updatedAt":"2026-02-09T18:00:00.000Z"},
      {"id":"seed-6","title":"Business Architect","company":"Differentis","recruiter":"","location":"United Kingdom (Hybrid)","ir35":"unspecified","rate":"","duration":"Permanent","jobType":"permanent","starred":false,"status":"applied","dateApplied":"2026-02-10","jobLink":"https://www.linkedin.com/jobs/view/4360552886/","notes":"Permanent role. Hybrid working. 30 days annual leave, private health care, pension. Requires TOGAF/BIZBOK frameworks.","createdAt":"2026-02-10T10:00:00.000Z","updatedAt":"2026-02-10T10:00:00.000Z"}
    ];

    /* === State === */
    let jobs = [];
    let activeFilter = 'all';
    let searchTerm = '';
    let sortBy = 'rate-high';
    let viewMode = 'cards';
    let editingId = null;
    let deleteId = null;
    let isSaving = false;

    /* === DOM References === */
    const cardsContainer = document.getElementById('cardsContainer');
    const jobCount = document.getElementById('jobCount');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const jobForm = document.getElementById('jobForm');
    const confirmOverlay = document.getElementById('confirmOverlay');
    const confirmMessage = document.getElementById('confirmMessage');
    const searchBox = document.getElementById('searchBox');
    const sortSelect = document.getElementById('sortSelect');
    const filterBar = document.getElementById('filterBar');
    const dateGroup = document.getElementById('dateGroup');
    const fieldStatus = document.getElementById('fieldStatus');

    /* === Database Storage (Upstash Redis via serverless API) === */

    // Save jobs to the database (called after every add/edit/delete)
    async function saveJobs() {
      // Also keep a local copy in localStorage for fast loading
      localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs));
      localStorage.setItem(SYNC_TS_KEY, new Date().toISOString());

      // Save to the database in the background
      if (isSaving) return;
      isSaving = true;
      updateSyncStatus('Saving...');

      try {
        const response = await authFetch('/api/jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ jobs: jobs, lastModified: new Date().toISOString() })
        });

        if (!response.ok) throw new Error('Save failed');
        const result = await response.json();
        updateSyncStatus('Saved just now');
      } catch (err) {
        console.error('Failed to save to database:', err);
        updateSyncStatus('Saved locally (offline)');
      } finally {
        isSaving = false;
      }
    }

    // Load jobs from the database, falling back to localStorage or seed data
    async function initJobs() {
      updateSyncStatus('Loading...');

      // First, show whatever we have locally for a quick start
      const localData = localStorage.getItem(STORAGE_KEY);
      if (localData) {
        try {
          jobs = JSON.parse(localData);
          renderJobs();
        } catch (e) { /* ignore bad local data */ }
      }

      // Then try to fetch the latest from the database
      try {
        const response = await authFetch('/api/jobs');
        if (!response.ok) throw new Error('Fetch failed');
        const data = await response.json();

        if (data.jobs && data.jobs.length > 0) {
          // Database has data, use it (it's the single source of truth)
          jobs = data.jobs;
          localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs));
          localStorage.setItem(SYNC_TS_KEY, data.lastModified || new Date().toISOString());
          renderJobs();
          updateSyncStatus('Synced');
        } else if (!localData || JSON.parse(localData).length === 0) {
          // Database is empty and no local data, seed with initial jobs
          jobs = SEED_JOBS.slice();
          renderJobs();
          // Save seed data to the database
          await saveJobs();
          updateSyncStatus('Initialised');
        } else {
          // Database is empty but we have local data, push it up
          await saveJobs();
          updateSyncStatus('Synced');
        }
      } catch (err) {
        console.error('Could not reach database:', err);
        // Offline, use whatever we loaded locally (or seed data)
        if (jobs.length === 0) {
          jobs = SEED_JOBS.slice();
          localStorage.setItem(STORAGE_KEY, JSON.stringify(jobs));
        }
        renderJobs();
        updateSyncStatus('Offline mode');
      }
    }

    // Update the small status text under the title
    function updateSyncStatus(message) {
      const statusEl = document.getElementById('syncStatus');
      if (statusEl) statusEl.textContent = message;
    }

    function showToast(message) {
      var toast = document.getElementById('syncToast');
      if (!toast) return;
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(function() { toast.classList.remove('show'); }, 5000);
    }

    /* === Formatting Helpers === */
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const parts = dateStr.split('-');
      if (parts.length !== 3) return dateStr;
      const day = parseInt(parts[2], 10);
      const month = months[parseInt(parts[1], 10) - 1];
      const year = parts[0];
      return day + ' ' + month + ' ' + year;
    }

    function formatRate(rate) {
      if (!rate) return '';
      return '\u00A3' + rate + '/day';
    }

    function parseRate(rate) {
      if (!rate) return 0;
      const match = rate.match(/\d+/);
      return match ? parseInt(match[0], 10) : 0;
    }

    function getStatusBadgeClass(status) {
      return 'badge badge-' + status;
    }

    function getIR35BadgeClass(ir35) {
      if (ir35 === 'outside') return 'badge badge-ir35-outside';
      if (ir35 === 'inside') return 'badge badge-ir35-inside';
      return '';
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    /* === Filtering & Sorting === */
    function getFilteredAndSorted() {
      let filtered = jobs.slice();

      // Filter by status
      if (activeFilter !== 'all') {
        filtered = filtered.filter(function(job) {
          return job.status === activeFilter;
        });
      }

      // Filter by search term (searches title, company, recruiter, and notes)
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = filtered.filter(function(job) {
          return (job.title && job.title.toLowerCase().includes(term)) ||
                 (job.company && job.company.toLowerCase().includes(term)) ||
                 (job.recruiter && job.recruiter.toLowerCase().includes(term)) ||
                 (job.notes && job.notes.toLowerCase().includes(term));
        });
      }

      // Sort
      filtered.sort(function(a, b) {
        if (sortBy === 'starred') {
          // Starred jobs come first, then sort by newest within each group
          const aStarred = a.starred ? 1 : 0;
          const bStarred = b.starred ? 1 : 0;
          if (bStarred !== aStarred) return bStarred - aStarred;
          return new Date(b.createdAt) - new Date(a.createdAt);
        }
        if (sortBy === 'newest') {
          return new Date(b.createdAt) - new Date(a.createdAt);
        }
        if (sortBy === 'oldest') {
          return new Date(a.createdAt) - new Date(b.createdAt);
        }
        if (sortBy === 'company') {
          return (a.company || '').localeCompare(b.company || '');
        }
        if (sortBy === 'rate-high') {
          return parseRate(b.rate) - parseRate(a.rate);
        }
        if (sortBy === 'type') {
          // Permanent first, then contract, then sort by newest within each group
          const typeOrder = { 'permanent': 0, 'contract': 1 };
          const aOrder = typeOrder[a.jobType] !== undefined ? typeOrder[a.jobType] : 2;
          const bOrder = typeOrder[b.jobType] !== undefined ? typeOrder[b.jobType] : 2;
          if (aOrder !== bOrder) return aOrder - bOrder;
          return new Date(b.createdAt) - new Date(a.createdAt);
        }
        return 0;
      });

      return filtered;
    }

    /* === Rendering === */
    function renderJobs() {
      const filtered = getFilteredAndSorted();

      // Update the job count in the header
      const total = jobs.length;
      const showing = filtered.length;
      if (total === showing) {
        jobCount.textContent = total + ' application' + (total !== 1 ? 's' : '');
      } else {
        jobCount.textContent = 'Showing ' + showing + ' of ' + total;
      }

      // Set the correct CSS class for the current view mode
      cardsContainer.className = 'cards-container view-' + viewMode;

      // Empty state
      if (filtered.length === 0) {
        if (jobs.length === 0) {
          cardsContainer.innerHTML = '<div class="empty-state"><p>No jobs tracked yet.</p><p class="empty-hint">Click "+ Add New Job" to get started.</p></div>';
        } else {
          cardsContainer.innerHTML = '<div class="empty-state"><p>No jobs match your filters.</p><p class="empty-hint">Try a different filter or clear your search.</p></div>';
        }
        return;
      }

      // Build HTML for both card and list views
      let html = '';
      filtered.forEach(function(job) {
        html += renderCard(job);
        html += renderListRow(job);
      });
      cardsContainer.innerHTML = html;
      renderStats();
      updateTabCounts();
    }

    /* === Stats Dashboard === */
    function renderStats() {
      var counts = { 'want-to-apply': 0, 'applied': 0, 'interview': 0, 'offered': 0, 'rejected': 0, 'no-response': 0 };
      jobs.forEach(function(j) {
        if (counts.hasOwnProperty(j.status)) counts[j.status]++;
      });

      var totalApplied = counts.applied + counts.interview + counts.offered + counts.rejected + counts['no-response'];
      var responses = counts.interview + counts.offered;
      var responseRate = totalApplied > 0 ? Math.round((responses / totalApplied) * 100) + '%' : 'N/A';

      // Days since last application
      var daysIdle = 'N/A';
      var latestDate = null;
      jobs.forEach(function(j) {
        if (j.dateApplied) {
          var d = new Date(j.dateApplied);
          if (!latestDate || d > latestDate) latestDate = d;
        }
      });
      if (latestDate) {
        var diff = Math.floor((new Date() - latestDate) / (1000 * 60 * 60 * 24));
        daysIdle = diff;
      }

      // Follow-up alerts (applied jobs older than 7 days)
      var needFollowUp = 0;
      var now = new Date();
      jobs.forEach(function(j) {
        if (j.status === 'applied' && j.dateApplied) {
          var applied = new Date(j.dateApplied);
          var daysSince = Math.floor((now - applied) / (1000 * 60 * 60 * 24));
          if (daysSince >= 7) needFollowUp++;
        }
      });

      // Pipeline bar
      var total = jobs.length;
      var pipelineColors = {
        'want-to-apply': 'var(--status-want)',
        'applied': 'var(--status-applied)',
        'interview': 'var(--status-interview)',
        'offered': 'var(--status-offered)',
        'rejected': 'var(--status-rejected)',
        'no-response': 'var(--status-no-response)'
      };
      var pipelineLabels = {
        'want-to-apply': 'Want to Apply',
        'applied': 'Applied',
        'interview': 'Interview',
        'offered': 'Offered',
        'rejected': 'Rejected',
        'no-response': 'No Response'
      };

      var pipelineHtml = '';
      var legendHtml = '';
      var statuses = ['want-to-apply', 'applied', 'interview', 'offered', 'rejected', 'no-response'];
      statuses.forEach(function(s) {
        if (counts[s] > 0) {
          var pct = (counts[s] / total * 100).toFixed(1);
          pipelineHtml += '<div class="pipeline-segment" style="width:' + pct + '%;background:' + pipelineColors[s] + '"></div>';
        }
        if (counts[s] > 0) {
          legendHtml += '<span class="pipeline-legend-item"><span class="pipeline-legend-dot" style="background:' + pipelineColors[s] + '"></span>' + pipelineLabels[s] + ' (' + counts[s] + ')</span>';
        }
      });

      var followUpHtml = '';
      if (needFollowUp > 0) {
        followUpHtml = '<div class="stats-follow-up-alert">&#128340; ' + needFollowUp + ' application' + (needFollowUp !== 1 ? 's' : '') + ' may need a follow-up (no response in 7+ days)</div>';
      }

      document.getElementById('statsBar').innerHTML =
        '<div class="stat-item"><div class="stat-value">' + totalApplied + '</div><div class="stat-label">Applied</div></div>' +
        '<div class="stat-divider"></div>' +
        '<div class="stat-item"><div class="stat-value">' + responseRate + '</div><div class="stat-label">Response Rate</div></div>' +
        '<div class="stat-divider"></div>' +
        '<div class="stat-item"><div class="stat-value">' + counts.interview + '</div><div class="stat-label">Interviews</div></div>' +
        '<div class="stat-divider"></div>' +
        '<div class="stat-item"><div class="stat-value">' + daysIdle + '</div><div class="stat-label">Days Idle</div></div>' +
        (total > 0 ? '<div class="pipeline-section"><div class="pipeline-bar">' + pipelineHtml + '</div><div class="pipeline-legend">' + legendHtml + '</div></div>' : '') +
        followUpHtml;
    }

    /* === Follow-up Status Helper === */
    function getFollowUpStatus(job) {
      if (job.status !== 'applied' && job.status !== 'interview') return null;

      var now = new Date();

      if (job.status === 'applied' && job.dateApplied) {
        var applied = new Date(job.dateApplied);
        var diffDays = Math.floor((now - applied) / (1000 * 60 * 60 * 24));
        if (diffDays >= 10) {
          return { level: 'overdue', message: 'No response in ' + diffDays + ' days. Consider following up or moving on.' };
        }
        if (diffDays >= 5) {
          return { level: 'nudge', message: 'Applied ' + diffDays + ' days ago. Consider sending a follow-up.' };
        }
      }

      if (job.status === 'interview' && job.followUpDate) {
        var followUp = new Date(job.followUpDate);
        var followDiff = Math.floor((now - followUp) / (1000 * 60 * 60 * 24));
        if (followDiff >= 0) {
          return { level: 'nudge', message: 'Follow-up date has arrived. Time to chase!' };
        }
      }

      return null;
    }

    /* Renders a full card (shown in card view, hidden in list view) */
    function renderCard(job) {
      const statusLabel = STATUS_LABELS[job.status] || job.status;
      const statusBadge = '<span class="' + getStatusBadgeClass(job.status) + '">' + statusLabel + '</span>';

      let ir35Badge = '';
      if (job.ir35 && job.ir35 !== 'unspecified') {
        const ir35Label = IR35_LABELS[job.ir35];
        ir35Badge = '<span class="' + getIR35BadgeClass(job.ir35) + '">' + ir35Label + '</span>';
      }

      // Job type badge (Permanent or Contract)
      let typeBadge = '';
      if (job.jobType) {
        const typeLabel = JOB_TYPE_LABELS[job.jobType] || job.jobType;
        typeBadge = '<span class="badge badge-' + job.jobType + '">' + typeLabel + '</span>';
      }

      // Star button
      const starClass = job.starred ? 'btn-star starred' : 'btn-star';
      const starIcon = job.starred ? '&#9733;' : '&#9734;';
      const starBtn = '<button class="' + starClass + '" data-id="' + job.id + '" data-action="star" title="' + (job.starred ? 'Remove from favourites' : 'Add to favourites') + '">' + starIcon + '</button>';

      let detailsHtml = '';
      if (job.location) {
        detailsHtml += '<span class="card-detail"><span class="card-detail-label">Location</span> ' + escapeHtml(job.location) + '</span>';
      }
      if (job.rate) {
        detailsHtml += '<span class="card-detail"><span class="card-detail-label">Rate</span> ' + formatRate(job.rate) + '</span>';
      }
      if (job.duration) {
        detailsHtml += '<span class="card-detail"><span class="card-detail-label">Duration</span> ' + escapeHtml(job.duration) + '</span>';
      }
      if (job.dateApplied) {
        detailsHtml += '<span class="card-detail"><span class="card-detail-label">Applied</span> ' + formatDate(job.dateApplied) + '</span>';
      }

      let notesHtml = '';
      if (job.notes) {
        notesHtml = '<div class="card-notes"><span class="card-notes-label">Notes</span> ' + escapeHtml(job.notes) + '</div>';
      }

      // Interview info (only for jobs at interview stage)
      var interviewHtml = '';
      if (job.status === 'interview') {
        var interviewParts = [];
        if (job.interviewDate) {
          var intDate = new Date(job.interviewDate);
          var nowDate = new Date();
          var diffDays = Math.ceil((intDate - nowDate) / (1000 * 60 * 60 * 24));
          var dateDisplay = intDate.toLocaleDateString('en-GB', {
            weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
          });
          var countdown = '';
          if (diffDays > 0) {
            countdown = ' <span class="interview-countdown">(in ' + diffDays + ' day' + (diffDays !== 1 ? 's' : '') + ')</span>';
          } else if (diffDays === 0) {
            countdown = ' <span class="interview-countdown">(today!)</span>';
          } else {
            countdown = ' <span style="color:var(--color-text-secondary)">(passed)</span>';
          }
          interviewParts.push('<span class="interview-info-label">When</span> ' + dateDisplay + countdown);
        }
        if (job.interviewType) {
          var typeLabels = { phone: 'Phone call', video: 'Video call', 'in-person': 'In person', panel: 'Panel interview' };
          interviewParts.push('<span class="interview-info-label">Type</span> ' + (typeLabels[job.interviewType] || job.interviewType));
        }
        if (job.interviewerName) {
          interviewParts.push('<span class="interview-info-label">With</span> ' + escapeHtml(job.interviewerName));
        }
        if (job.interviewNotes) {
          interviewParts.push('<span class="interview-info-label">Notes</span> ' + escapeHtml(job.interviewNotes));
        }
        if (interviewParts.length > 0) {
          interviewHtml = '<div class="interview-info">' + interviewParts.join('<br>') + '</div>';
        }
      }

      // Follow-up reminder
      var followUpHtml = '';
      var followUp = getFollowUpStatus(job);
      if (followUp) {
        var followClass = followUp.level === 'overdue' ? 'follow-up-warning follow-up-overdue' : 'follow-up-warning follow-up-nudge';
        var icon = followUp.level === 'overdue' ? '&#9888;' : '&#128340;';
        followUpHtml = '<div class="' + followClass + '"><span class="follow-up-icon">' + icon + '</span> ' + followUp.message + '</div>';
      }

      let linkHtml = '';
      if (job.jobLink) {
        linkHtml = '<a class="card-link" href="' + escapeHtml(job.jobLink) + '" target="_blank" rel="noopener">View Job Ad</a>';
      }

      return '<article class="job-card">' +
        '<div class="card-top">' +
          starBtn +
          '<div style="flex:1;min-width:0">' +
            '<div class="card-title">' + escapeHtml(job.title) + '</div>' +
            '<div class="card-company">' + escapeHtml(job.company) + '</div>' +
            (job.recruiter ? '<div class="card-recruiter">Recruiter: ' + escapeHtml(job.recruiter) + '</div>' : '') +
          '</div>' +
          '<div style="display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end">' + typeBadge + statusBadge + ir35Badge + '</div>' +
        '</div>' +
        (detailsHtml ? '<div class="card-details">' + detailsHtml + '</div>' : '') +
        notesHtml +
        interviewHtml +
        followUpHtml +
        linkHtml +
        '<div class="card-actions">' +
          '<button class="btn-edit" data-id="' + job.id + '">Edit</button>' +
          '<button class="btn-delete" data-id="' + job.id + '" aria-label="Remove ' + escapeHtml(job.title) + ' at ' + escapeHtml(job.company) + '">Remove</button>' +
        '</div>' +
      '</article>';
    }

    /* Renders a compact list row (shown in list view, hidden in card view) */
    function renderListRow(job) {
      const statusLabel = STATUS_LABELS[job.status] || job.status;
      const statusBadge = '<span class="' + getStatusBadgeClass(job.status) + '">' + statusLabel + '</span>';

      let ir35Badge = '';
      if (job.ir35 && job.ir35 !== 'unspecified') {
        const ir35Label = IR35_LABELS[job.ir35];
        ir35Badge = '<span class="' + getIR35BadgeClass(job.ir35) + '">' + ir35Label + '</span>';
      }

      // Job type badge for list view
      let typeBadge = '';
      if (job.jobType) {
        const typeLabel = JOB_TYPE_LABELS[job.jobType] || job.jobType;
        typeBadge = '<span class="badge badge-' + job.jobType + '">' + typeLabel + '</span>';
      }

      // Star button for list view
      const starClass = job.starred ? 'btn-star starred' : 'btn-star';
      const starIcon = job.starred ? '&#9733;' : '&#9734;';
      const starBtn = '<button class="' + starClass + '" data-id="' + job.id + '" data-action="star" title="' + (job.starred ? 'Remove from favourites' : 'Add to favourites') + '">' + starIcon + '</button>';

      const rateText = job.rate ? formatRate(job.rate) : '';

      // Follow-up indicator for list view
      var listFollowUp = getFollowUpStatus(job);
      var listFollowUpHtml = '';
      if (listFollowUp) {
        var fuColor = listFollowUp.level === 'overdue' ? 'var(--status-rejected)' : '#f57f17';
        var fuIcon = listFollowUp.level === 'overdue' ? '&#9888;' : '&#128340;';
        listFollowUpHtml = '<span style="font-size:0.8rem;color:' + fuColor + '" title="' + listFollowUp.message + '">' + fuIcon + '</span>';
      }

      return '<div class="list-row">' +
        starBtn +
        '<div class="list-info">' +
          '<span class="list-title">' + escapeHtml(job.title) + '</span>' +
          '<span class="list-company">' + escapeHtml(job.company) + '</span>' +
          (rateText ? '<span class="list-rate">' + rateText + '</span>' : '') +
          (job.location ? '<span class="list-location">' + escapeHtml(job.location) + '</span>' : '') +
        '</div>' +
        '<div class="list-badges">' + listFollowUpHtml + typeBadge + statusBadge + ir35Badge + '</div>' +
        '<div class="list-actions">' +
          '<button class="btn-edit" data-id="' + job.id + '">Edit</button>' +
          '<button class="btn-delete" data-id="' + job.id + '">Remove</button>' +
        '</div>' +
      '</div>';
    }

    /* === Modal === */
    function openModal(jobId) {
      editingId = jobId || null;

      if (editingId) {
        modalTitle.textContent = 'Edit Job';
        document.getElementById('btnSave').textContent = 'Update';
        const job = jobs.find(function(j) { return j.id === editingId; });
        if (job) {
          document.getElementById('fieldTitle').value = job.title || '';
          document.getElementById('fieldCompany').value = job.company || '';
          document.getElementById('fieldRecruiter').value = job.recruiter || '';
          document.getElementById('fieldLocation').value = job.location || '';
          document.getElementById('fieldIR35').value = job.ir35 || 'unspecified';
          document.getElementById('fieldRate').value = job.rate || '';
          document.getElementById('fieldDuration').value = job.duration || '';
          document.getElementById('fieldJobType').value = job.jobType || 'contract';
          document.getElementById('fieldStatus').value = job.status || 'want-to-apply';
          document.getElementById('fieldDate').value = job.dateApplied || '';
          document.getElementById('fieldLink').value = job.jobLink || '';
          document.getElementById('fieldNotes').value = job.notes || '';
          // Interview fields
          document.getElementById('fieldInterviewDate').value = job.interviewDate || '';
          document.getElementById('fieldInterviewType').value = job.interviewType || '';
          document.getElementById('fieldInterviewerName').value = job.interviewerName || '';
          document.getElementById('fieldFollowUpDate').value = job.followUpDate || '';
          document.getElementById('fieldInterviewNotes').value = job.interviewNotes || '';
        }
      } else {
        modalTitle.textContent = 'Add New Job';
        document.getElementById('btnSave').textContent = 'Save';
        jobForm.reset();
        document.getElementById('fieldJobType').value = 'contract';
        document.getElementById('fieldStatus').value = 'want-to-apply';
      }

      toggleDateField();
      modalOverlay.classList.add('open');
      document.getElementById('fieldTitle').focus();
    }

    function closeModal() {
      modalOverlay.classList.remove('open');
      editingId = null;
      jobForm.reset();
    }

    /* Show/hide the date field based on status (hide for "Want to Apply") */
    /* Also show/hide interview fields when status is "Interview" */
    function toggleDateField() {
      const status = fieldStatus.value;
      if (status === 'want-to-apply') {
        dateGroup.style.display = 'none';
      } else {
        dateGroup.style.display = 'block';
      }
      var interviewFields = document.getElementById('interviewFields');
      if (interviewFields) {
        if (status === 'interview') {
          interviewFields.classList.add('visible');
        } else {
          interviewFields.classList.remove('visible');
        }
      }
    }

    /* === CRUD Operations === */
    function addJob(data) {
      const now = new Date().toISOString();
      const job = {
        id: 'job-' + Date.now() + '-' + Math.random().toString(36).substring(2, 7),
        title: data.title,
        company: data.company,
        recruiter: data.recruiter,
        location: data.location,
        ir35: data.ir35,
        rate: data.rate,
        duration: data.duration,
        jobType: data.jobType,
        starred: false,
        status: data.status,
        dateApplied: data.dateApplied,
        jobLink: data.jobLink,
        notes: data.notes,
        interviewDate: data.interviewDate || '',
        interviewType: data.interviewType || '',
        interviewerName: data.interviewerName || '',
        followUpDate: data.followUpDate || '',
        interviewNotes: data.interviewNotes || '',
        createdAt: now,
        updatedAt: now
      };
      jobs.push(job);
      saveJobs();
      renderJobs();
    }

    function updateJob(id, data) {
      const idx = jobs.findIndex(function(j) { return j.id === id; });
      if (idx === -1) return;
      jobs[idx] = Object.assign({}, jobs[idx], data, { updatedAt: new Date().toISOString() });
      saveJobs();
      renderJobs();
    }

    function deleteJob(id) {
      jobs = jobs.filter(function(j) { return j.id !== id; });
      saveJobs();
      renderJobs();
    }

    /* Toggle the starred/favourite status of a job */
    function toggleStar(id) {
      const idx = jobs.findIndex(function(j) { return j.id === id; });
      if (idx === -1) return;
      jobs[idx].starred = !jobs[idx].starred;
      jobs[idx].updatedAt = new Date().toISOString();
      saveJobs();
      renderJobs();
    }

    /* === Confirm Dialog === */
    function openConfirm(id) {
      deleteId = id;
      const job = jobs.find(function(j) { return j.id === id; });
      if (job) {
        confirmMessage.textContent = 'Are you sure you want to remove "' + job.title + '" at ' + job.company + '?';
      }
      confirmOverlay.classList.add('open');
    }

    function closeConfirm() {
      confirmOverlay.classList.remove('open');
      deleteId = null;
    }

    /* === Job Feed State === */
    let feedItems = [];
    let feedMeta = {};

    /* === Feed Functions === */

    // Parse a date string that might be in DD/MM/YYYY format (from Reed)
    // or standard ISO format (from Adzuna/Jooble)
    function parseDate(str) {
      if (!str) return null;
      // Check for DD/MM/YYYY pattern
      var parts = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
      if (parts) {
        return new Date(parseInt(parts[3]), parseInt(parts[2]) - 1, parseInt(parts[1]));
      }
      return new Date(str);
    }

    // Load feed items from the server
    async function loadFeed() {
      var feedMetaEl = document.getElementById('feedMeta');
      var feedCountEl = document.getElementById('feedCount');
      feedMetaEl.textContent = 'Loading feed...';

      try {
        var response = await authFetch('/api/feed');
        if (!response.ok) throw new Error('Feed fetch failed');
        var data = await response.json();

        feedItems = data.items || [];
        feedMeta = data.meta || {};
        renderFeed();
      } catch (err) {
        console.error('Failed to load feed:', err);
        feedMetaEl.textContent = 'Could not load feed';
        feedCountEl.textContent = '0';
      }
    }

    // Render feed cards
    function renderFeed() {
      var container = document.getElementById('feedCards');
      var feedCountEl = document.getElementById('feedCount');
      var feedMetaEl = document.getElementById('feedMeta');

      feedCountEl.textContent = feedItems.length;

      // Show when the last scan happened
      if (feedMeta.lastScan) {
        var scanDate = new Date(feedMeta.lastScan);
        var now = new Date();
        var hoursAgo = Math.round((now - scanDate) / (1000 * 60 * 60));
        if (hoursAgo < 1) {
          feedMetaEl.textContent = 'Last scanned: just now';
        } else if (hoursAgo < 24) {
          feedMetaEl.textContent = 'Last scanned: ' + hoursAgo + ' hour' + (hoursAgo !== 1 ? 's' : '') + ' ago';
        } else {
          var daysAgo = Math.round(hoursAgo / 24);
          feedMetaEl.textContent = 'Last scanned: ' + daysAgo + ' day' + (daysAgo !== 1 ? 's' : '') + ' ago';
        }
      } else {
        feedMetaEl.textContent = 'No scans yet';
      }

      if (feedItems.length === 0) {
        container.innerHTML = '<div class="feed-empty">No new jobs found. The feed scans daily for "Business Architect" roles on Reed and Adzuna.</div>';
        return;
      }

      // Sort by most recently published first
      feedItems.sort(function(a, b) {
        var dateA = a.datePosted ? parseDate(a.datePosted) : new Date(0);
        var dateB = b.datePosted ? parseDate(b.datePosted) : new Date(0);
        return dateB - dateA;
      });

      var html = '';
      feedItems.forEach(function(item) {
        var sourceClass = 'feed-source feed-source-' + item.source;

        var details = '';
        if (item.location) details += '<span>' + escapeHtml(item.location) + '</span>';
        if (item.salaryText) details += '<span>' + escapeHtml(String(item.salaryText)) + '</span>';
        if (item.jobType) {
          var typeLabel = item.jobType === 'permanent' ? 'Permanent' : 'Contract';
          details += '<span>' + typeLabel + '</span>';
        }
        if (item.datePosted) {
          var posted = parseDate(item.datePosted);
          if (posted && !isNaN(posted.getTime())) {
            var day = posted.getDate();
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            var dateStr = day + ' ' + months[posted.getMonth()] + ' ' + posted.getFullYear();
            details += '<span>Posted ' + dateStr + '</span>';
          }
        }

        html += '<div class="feed-card">' +
          '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">' +
            '<div>' +
              '<div class="feed-card-title">' + escapeHtml(item.title) + '</div>' +
              '<div class="feed-card-company">' + escapeHtml(item.company) + '</div>' +
            '</div>' +
            '<span class="' + sourceClass + '">' + item.source + '</span>' +
          '</div>' +
          (details ? '<div class="feed-card-details">' + details + '</div>' : '') +
          (item.description ? '<div class="feed-card-desc">' + escapeHtml(item.description) + '</div>' : '') +
          (item.jobLink ? '<a class="card-link" href="' + escapeHtml(item.jobLink) + '" target="_blank" rel="noopener">View original listing</a>' : '') +
          '<div class="feed-card-actions">' +
            '<button class="btn-track" data-feed-id="' + item.id + '" data-action="add">+ Add to Tracker</button>' +
            '<button class="btn-dismiss" data-feed-id="' + item.id + '" data-action="dismiss">Dismiss</button>' +
          '</div>' +
        '</div>';
      });

      container.innerHTML = html;
    }

    // Dismiss a feed item (hide it permanently)
    async function dismissFeedItem(feedItemId) {
      try {
        var response = await authFetch('/api/feed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'dismiss', feedItemId: feedItemId }),
        });
        if (!response.ok) throw new Error('Dismiss failed');

        // Remove from local array and re-render
        feedItems = feedItems.filter(function(item) { return item.id !== feedItemId; });
        renderFeed();
        showToast('Job dismissed');
      } catch (err) {
        console.error('Dismiss error:', err);
        showToast('Failed to dismiss job');
      }
    }

    // Add a feed item to the main job tracker
    async function addFeedToTracker(feedItemId) {
      try {
        var response = await authFetch('/api/feed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'add-to-tracker', feedItemId: feedItemId }),
        });
        if (!response.ok) throw new Error('Add to tracker failed');

        // Remove from feed and re-render feed
        feedItems = feedItems.filter(function(item) { return item.id !== feedItemId; });
        renderFeed();

        // Reload the main job list so the new job appears
        await initJobs();
        showToast('Job added to your tracker');
      } catch (err) {
        console.error('Add to tracker error:', err);
        showToast('Failed to add job to tracker');
      }
    }

    /* ================================================================
       RECRUITERS SECTION
       ================================================================ */

    /* === Recruiter Constants === */
    const REC_STORAGE_KEY = 'jobTracker_recruiters';
    const REC_SYNC_TS_KEY = 'jobTracker_recruitersLastModified';

    const REC_STATUS_LABELS = {
      'not-contacted': 'Not Yet Contacted',
      'reached-out': 'Reached Out',
      'active': 'In Active Contact',
      'quiet': 'Gone Quiet',
      'not-useful': 'Not Useful'
    };

    const REC_STATUS_BADGE_CLASS = {
      'not-contacted': 'rec-badge rec-badge-not-contacted',
      'reached-out': 'rec-badge rec-badge-reached-out',
      'active': 'rec-badge rec-badge-active',
      'quiet': 'rec-badge rec-badge-quiet',
      'not-useful': 'rec-badge rec-badge-not-useful'
    };

    const ROLE_STATUS_LABELS = {
      'mentioned': 'Mentioned',
      'cv-submitted': 'CV Submitted',
      'interview': 'Interview Stage',
      'rejected': 'Rejected',
      'withdrawn': 'Withdrawn'
    };

    const ROLE_STATUS_BADGE_CLASS = {
      'mentioned': 'role-badge role-badge-mentioned',
      'cv-submitted': 'role-badge role-badge-cv-submitted',
      'interview': 'role-badge role-badge-interview',
      'rejected': 'role-badge role-badge-rejected',
      'withdrawn': 'role-badge role-badge-withdrawn'
    };

    /* === Recruiter State === */
    let recruiters = [];
    let expandedRecruiterId = null;
    let activePage = 'jobs';  // 'jobs' or 'recruiters'
    let isRecSaving = false;

    /* === Recruiter DOM References === */
    const recList = document.getElementById('recList');
    const recCount = document.getElementById('recCount');

    /* === Page Tab Switching === */
    function switchPage(page) {
      activePage = page;
      const jobsView = document.getElementById('jobsView');
      const recPanel = document.getElementById('recruitersPanel');
      const statsBar = document.getElementById('statsBar');
      const headerButtons = document.querySelector('.header-buttons');

      // Toggle visibility
      if (page === 'jobs') {
        jobsView.style.display = 'block';
        recPanel.classList.remove('visible');
        if (headerButtons) headerButtons.style.display = 'flex';
      } else {
        jobsView.style.display = 'none';
        recPanel.classList.add('visible');
        if (headerButtons) headerButtons.style.display = 'none';
        renderRecruiters();
      }

      // Update tab active states
      document.querySelectorAll('.page-tab').forEach(function(tab) {
        tab.classList.toggle('active', tab.dataset.page === page);
      });
    }

    /* Update the tab counts */
    function updateTabCounts() {
      var jobsTabCount = document.getElementById('jobsTabCount');
      var recTabCount = document.getElementById('recruitersTabCount');
      if (jobsTabCount) jobsTabCount.textContent = jobs.length;
      if (recTabCount) recTabCount.textContent = recruiters.length;
    }

    /* === Recruiter Persistence (Upstash Redis via /api/recruiters) === */

    async function saveRecruiters() {
      // Keep a local copy for fast loading
      localStorage.setItem(REC_STORAGE_KEY, JSON.stringify(recruiters));
      localStorage.setItem(REC_SYNC_TS_KEY, new Date().toISOString());

      // Save to database in background
      if (isRecSaving) return;
      isRecSaving = true;

      try {
        const response = await authFetch('/api/recruiters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ recruiters: recruiters, lastModified: new Date().toISOString() })
        });
        if (!response.ok) throw new Error('Save failed');
      } catch (err) {
        console.error('Failed to save recruiters:', err);
      } finally {
        isRecSaving = false;
      }
    }

    async function initRecruiters() {
      // Load from localStorage first for quick display
      const localData = localStorage.getItem(REC_STORAGE_KEY);
      if (localData) {
        try {
          recruiters = JSON.parse(localData);
        } catch (e) { /* ignore bad data */ }
      }

      // Then fetch latest from the database
      try {
        const response = await authFetch('/api/recruiters');
        if (!response.ok) throw new Error('Fetch failed');
        const data = await response.json();

        if (data.recruiters && data.recruiters.length > 0) {
          recruiters = data.recruiters;
          localStorage.setItem(REC_STORAGE_KEY, JSON.stringify(recruiters));
        } else if (recruiters.length > 0) {
          // Local data exists but database is empty, push up
          await saveRecruiters();
        }
      } catch (err) {
        console.error('Could not load recruiters from database:', err);
      }

      updateTabCounts();
      if (activePage === 'recruiters') {
        renderRecruiters();
      }
    }

    /* === Recruiter Sorting === */
    // Priority flagged first, then by status (active > reached-out > quiet > not-useful), then by last contacted date
    function sortRecruiters(list) {
      const statusOrder = { 'active': 0, 'reached-out': 1, 'quiet': 2, 'not-useful': 3 };
      return list.slice().sort(function(a, b) {
        // Priority first
        const aPri = a.priority ? 0 : 1;
        const bPri = b.priority ? 0 : 1;
        if (aPri !== bPri) return aPri - bPri;

        // Then follow-up flagged
        const aFu = a.followUp ? 0 : 1;
        const bFu = b.followUp ? 0 : 1;
        if (aFu !== bFu) return aFu - bFu;

        // Then by status order
        const aStatus = statusOrder[a.status] !== undefined ? statusOrder[a.status] : 9;
        const bStatus = statusOrder[b.status] !== undefined ? statusOrder[b.status] : 9;
        if (aStatus !== bStatus) return aStatus - bStatus;

        // Then by most recently contacted
        const aDate = a.lastContactedDate || a.dateReachedOut || a.createdAt || '';
        const bDate = b.lastContactedDate || b.dateReachedOut || b.createdAt || '';
        return bDate.localeCompare(aDate);
      });
    }

    /* === Recruiter Rendering === */
    function renderRecruiters() {
      const sorted = sortRecruiters(recruiters);

      // Update counts
      recCount.textContent = recruiters.length + ' recruiter' + (recruiters.length !== 1 ? 's' : '');
      updateTabCounts();

      // Empty state
      if (sorted.length === 0) {
        recList.innerHTML = '<div class="rec-empty-state"><p>No recruiters tracked yet.</p><p class="empty-hint">Add a company or agency above to get started.</p></div>';
        return;
      }

      let html = '';
      sorted.forEach(function(rec) {
        html += renderRecCard(rec);
      });
      recList.innerHTML = html;
    }

    function renderRecCard(rec) {
      const statusLabel = REC_STATUS_LABELS[rec.status] || rec.status;
      const statusBadge = '<span class="' + (REC_STATUS_BADGE_CLASS[rec.status] || 'rec-badge') + '">' + statusLabel + '</span>';

      // Date display
      const dateStr = rec.lastContactedDate || rec.dateReachedOut || '';
      const dateDisplay = dateStr ? formatDate(dateStr) : '';

      // Priority flag
      const priClass = 'rec-flag' + (rec.priority ? ' flag-active' : '');
      const priIcon = rec.priority ? '&#9733;' : '&#9734;';
      const priBtn = '<button class="' + priClass + '" data-rec-id="' + rec.id + '" data-rec-action="priority" title="' + (rec.priority ? 'Remove priority' : 'Mark as priority') + '">' + priIcon + '</button>';

      // Follow-up flag
      const fuClass = 'rec-flag rec-flag-followup' + (rec.followUp ? ' flag-active' : '');
      const fuIcon = rec.followUp ? '&#128276;' : '&#128277;';
      const fuBtn = '<button class="' + fuClass + '" data-rec-id="' + rec.id + '" data-rec-action="followup" title="' + (rec.followUp ? 'Clear follow-up' : 'Flag for follow-up') + '">' + fuIcon + '</button>';

      const isExpanded = expandedRecruiterId === rec.id;

      let detailHtml = '';
      if (isExpanded) {
        detailHtml = renderRecDetail(rec);
      }

      return '<div class="rec-card" data-rec-id="' + rec.id + '">' +
        '<div class="rec-summary" data-rec-id="' + rec.id + '" data-rec-action="toggle">' +
          '<div class="rec-info">' +
            '<div class="rec-company">' + escapeHtml(rec.company) + '</div>' +
            (rec.contact ? '<div class="rec-contact-name">' + escapeHtml(rec.contact) + '</div>' : '') +
          '</div>' +
          '<div class="rec-meta">' +
            (dateDisplay ? '<span class="rec-date">' + dateDisplay + '</span>' : '') +
            statusBadge +
            priBtn +
            fuBtn +
          '</div>' +
        '</div>' +
        detailHtml +
      '</div>';
    }

    function renderRecDetail(rec) {
      // Build the roles list
      const roles = rec.roles || [];
      let rolesHtml = '';

      if (roles.length === 0) {
        rolesHtml = '<div class="rec-roles-empty">No roles listed yet.</div>';
      } else {
        roles.forEach(function(role) {
          const roleStatusLabel = ROLE_STATUS_LABELS[role.status] || role.status;
          const roleBadge = '<span class="' + (ROLE_STATUS_BADGE_CLASS[role.status] || 'role-badge') + '">' + roleStatusLabel + '</span>';
          const roleDateStr = role.dateMentioned ? formatDate(role.dateMentioned) : '';

          rolesHtml += '<div class="rec-role-item">' +
            '<div class="rec-role-info">' +
              '<div class="rec-role-title">' + escapeHtml(role.title) + '</div>' +
              (role.company ? '<div class="rec-role-company">' + escapeHtml(role.company) + '</div>' : '') +
              (roleDateStr ? '<div class="rec-role-date">' + roleDateStr + '</div>' : '') +
              (role.comment ? '<div class="rec-role-comment">' + escapeHtml(role.comment) + '</div>' : '') +
            '</div>' +
            '<div class="rec-role-meta">' +
              roleBadge +
              '<button class="rec-role-delete" data-rec-id="' + rec.id + '" data-role-id="' + role.id + '" data-rec-action="delete-role" title="Remove role">&times;</button>' +
            '</div>' +
          '</div>';
        });
      }

      return '<div class="rec-detail">' +
        '<div class="rec-detail-grid">' +
          '<div class="rec-field">' +
            '<label>Phone</label>' +
            '<input type="text" value="' + escapeHtml(rec.phone || '') + '" data-rec-id="' + rec.id + '" data-rec-field="phone" placeholder="Phone number">' +
          '</div>' +
          '<div class="rec-field">' +
            '<label>Email</label>' +
            '<input type="email" value="' + escapeHtml(rec.email || '') + '" data-rec-id="' + rec.id + '" data-rec-field="email" placeholder="Email address">' +
          '</div>' +
          '<div class="rec-field">' +
            '<label>Specialism</label>' +
            '<input type="text" value="' + escapeHtml(rec.specialism || '') + '" data-rec-id="' + rec.id + '" data-rec-field="specialism" placeholder="e.g. Business Architecture, IT Contracting">' +
          '</div>' +
          '<div class="rec-field">' +
            '<label>Status</label>' +
            '<select data-rec-id="' + rec.id + '" data-rec-field="status">' +
              '<option value="not-contacted"' + (rec.status === 'not-contacted' ? ' selected' : '') + '>Not Yet Contacted</option>' +
              '<option value="reached-out"' + (rec.status === 'reached-out' ? ' selected' : '') + '>Reached Out</option>' +
              '<option value="active"' + (rec.status === 'active' ? ' selected' : '') + '>In Active Contact</option>' +
              '<option value="quiet"' + (rec.status === 'quiet' ? ' selected' : '') + '>Gone Quiet</option>' +
              '<option value="not-useful"' + (rec.status === 'not-useful' ? ' selected' : '') + '>Not Useful</option>' +
            '</select>' +
          '</div>' +
          '<div class="rec-field">' +
            '<label>Date First Reached Out</label>' +
            '<input type="date" value="' + (rec.dateReachedOut || '') + '" data-rec-id="' + rec.id + '" data-rec-field="dateReachedOut">' +
          '</div>' +
          '<div class="rec-field">' +
            '<label>Last Contacted</label>' +
            '<input type="date" value="' + (rec.lastContactedDate || '') + '" data-rec-id="' + rec.id + '" data-rec-field="lastContactedDate">' +
          '</div>' +
          '<div class="rec-field">' +
            '<label>Contact Name</label>' +
            '<input type="text" value="' + escapeHtml(rec.contact || '') + '" data-rec-id="' + rec.id + '" data-rec-field="contact" placeholder="Contact name">' +
          '</div>' +
          '<div class="rec-field full-width">' +
            '<label>Notes</label>' +
            '<textarea data-rec-id="' + rec.id + '" data-rec-field="notes" placeholder="Any notes about this recruiter...">' + escapeHtml(rec.notes || '') + '</textarea>' +
          '</div>' +
        '</div>' +
        '<div class="rec-roles-section">' +
          '<div class="rec-roles-header">Roles <span class="rec-roles-count">' + roles.length + '</span></div>' +
          rolesHtml +
          '<form class="rec-role-form" data-rec-id="' + rec.id + '" data-rec-action="add-role">' +
            '<input type="text" placeholder="Role title" required>' +
            '<input type="text" placeholder="Company">' +
            '<select>' +
              '<option value="mentioned">Mentioned</option>' +
              '<option value="cv-submitted">CV Submitted</option>' +
              '<option value="interview">Interview Stage</option>' +
              '<option value="rejected">Rejected</option>' +
              '<option value="withdrawn">Withdrawn</option>' +
            '</select>' +
            '<input type="text" placeholder="Comment (optional)">' +
            '<button type="submit" class="btn-add-role">+ Add</button>' +
          '</form>' +
        '</div>' +
        '<div class="rec-actions">' +
          '<button class="btn-delete-rec" data-rec-id="' + rec.id + '" data-rec-action="delete">Remove Recruiter</button>' +
        '</div>' +
      '</div>';
    }

    /* === Recruiter CRUD === */
    function addRecruiter(data) {
      const now = new Date().toISOString();
      const today = new Date().toISOString().split('T')[0];
      const rec = {
        id: 'rec-' + Date.now() + '-' + Math.random().toString(36).substring(2, 7),
        company: data.company,
        contact: data.contact || '',
        phone: '',
        email: '',
        specialism: '',
        status: data.status || 'reached-out',
        dateReachedOut: today,
        lastContactedDate: today,
        priority: false,
        followUp: false,
        notes: '',
        roles: [],
        createdAt: now,
        updatedAt: now
      };
      recruiters.push(rec);
      saveRecruiters();
      renderRecruiters();
    }

    // Update a single field on a recruiter without re-rendering (preserves focus)
    function updateRecField(recId, field, value) {
      const idx = recruiters.findIndex(function(r) { return r.id === recId; });
      if (idx === -1) return;
      recruiters[idx][field] = value;
      recruiters[idx].updatedAt = new Date().toISOString();
      saveRecruiters();
      // Only update tab counts, don't re-render (would lose focus)
      updateTabCounts();
    }

    function deleteRecruiter(recId) {
      recruiters = recruiters.filter(function(r) { return r.id !== recId; });
      if (expandedRecruiterId === recId) expandedRecruiterId = null;
      saveRecruiters();
      renderRecruiters();
    }

    function toggleRecPriority(recId) {
      const idx = recruiters.findIndex(function(r) { return r.id === recId; });
      if (idx === -1) return;
      recruiters[idx].priority = !recruiters[idx].priority;
      recruiters[idx].updatedAt = new Date().toISOString();
      saveRecruiters();
      renderRecruiters();
    }

    function toggleRecFollowUp(recId) {
      const idx = recruiters.findIndex(function(r) { return r.id === recId; });
      if (idx === -1) return;
      recruiters[idx].followUp = !recruiters[idx].followUp;
      recruiters[idx].updatedAt = new Date().toISOString();
      saveRecruiters();
      renderRecruiters();
    }

    function toggleRecExpand(recId) {
      if (expandedRecruiterId === recId) {
        expandedRecruiterId = null;
      } else {
        expandedRecruiterId = recId;
      }
      renderRecruiters();
    }

    /* === Role CRUD (nested under recruiters) === */
    function addRole(recId, roleData) {
      const idx = recruiters.findIndex(function(r) { return r.id === recId; });
      if (idx === -1) return;

      const role = {
        id: 'role-' + Date.now() + '-' + Math.random().toString(36).substring(2, 7),
        title: roleData.title,
        company: roleData.company || '',
        status: roleData.status || 'mentioned',
        dateMentioned: new Date().toISOString().split('T')[0],
        comment: roleData.comment || ''
      };
      recruiters[idx].roles = recruiters[idx].roles || [];
      recruiters[idx].roles.push(role);
      recruiters[idx].updatedAt = new Date().toISOString();
      saveRecruiters();
      renderRecruiters();
    }

    function deleteRole(recId, roleId) {
      const idx = recruiters.findIndex(function(r) { return r.id === recId; });
      if (idx === -1) return;
      recruiters[idx].roles = (recruiters[idx].roles || []).filter(function(r) { return r.id !== roleId; });
      recruiters[idx].updatedAt = new Date().toISOString();
      saveRecruiters();
      renderRecruiters();
    }

    /* === Event Listeners === */
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication first; initApp() runs after successful auth
      checkAuth();

      // Login form handler
      document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var password = document.getElementById('loginPassword').value;
        handleLogin(password);
      });

      // Add new job button
      document.getElementById('btnAdd').addEventListener('click', function() {
        openModal();
      });

      // Modal close
      document.getElementById('btnCancel').addEventListener('click', closeModal);
      modalOverlay.addEventListener('click', function(e) {
        if (e.target === modalOverlay) closeModal();
      });

      // Toggle date field visibility when status changes
      fieldStatus.addEventListener('change', toggleDateField);

      // Form submission (add or edit)
      jobForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const data = {
          title: document.getElementById('fieldTitle').value.trim(),
          company: document.getElementById('fieldCompany').value.trim(),
          recruiter: document.getElementById('fieldRecruiter').value.trim(),
          location: document.getElementById('fieldLocation').value.trim(),
          ir35: document.getElementById('fieldIR35').value,
          rate: document.getElementById('fieldRate').value.trim(),
          duration: document.getElementById('fieldDuration').value.trim(),
          jobType: document.getElementById('fieldJobType').value,
          status: document.getElementById('fieldStatus').value,
          dateApplied: document.getElementById('fieldDate').value,
          jobLink: document.getElementById('fieldLink').value.trim(),
          notes: document.getElementById('fieldNotes').value.trim(),
          interviewDate: document.getElementById('fieldInterviewDate').value,
          interviewType: document.getElementById('fieldInterviewType').value,
          interviewerName: document.getElementById('fieldInterviewerName').value.trim(),
          followUpDate: document.getElementById('fieldFollowUpDate').value,
          interviewNotes: document.getElementById('fieldInterviewNotes').value.trim()
        };

        if (!data.title || !data.company) return;

        if (editingId) {
          updateJob(editingId, data);
        } else {
          addJob(data);
        }
        closeModal();
      });

      // Edit, delete, and star buttons on cards/list rows (event delegation)
      cardsContainer.addEventListener('click', function(e) {
        const editBtn = e.target.closest('.btn-edit');
        const deleteBtn = e.target.closest('.btn-delete');
        const starBtn = e.target.closest('.btn-star');

        if (starBtn) {
          toggleStar(starBtn.dataset.id);
          return;
        }
        if (editBtn) {
          openModal(editBtn.dataset.id);
        }
        if (deleteBtn) {
          openConfirm(deleteBtn.dataset.id);
        }
      });

      // Confirm delete
      document.getElementById('btnConfirmDelete').addEventListener('click', function() {
        if (deleteId) {
          deleteJob(deleteId);
        }
        closeConfirm();
      });
      document.getElementById('btnConfirmCancel').addEventListener('click', closeConfirm);
      confirmOverlay.addEventListener('click', function(e) {
        if (e.target === confirmOverlay) closeConfirm();
      });

      // Filter buttons
      filterBar.addEventListener('click', function(e) {
        const btn = e.target.closest('.filter-btn');
        if (!btn) return;
        activeFilter = btn.dataset.filter;
        filterBar.querySelectorAll('.filter-btn').forEach(function(b) {
          b.classList.remove('active');
        });
        btn.classList.add('active');
        renderJobs();
      });

      // Sort dropdown
      sortSelect.addEventListener('change', function() {
        sortBy = sortSelect.value;
        renderJobs();
      });

      // Search with a short delay so it doesn't re-render on every keystroke
      let searchTimeout;
      searchBox.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
          searchTerm = searchBox.value.trim();
          renderJobs();
        }, 250);
      });

      // View toggle (Cards / List) - scoped to .view-toggle only
      document.querySelectorAll('.view-toggle .view-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          viewMode = btn.dataset.view;
          document.querySelectorAll('.view-toggle .view-btn').forEach(function(b) {
            b.classList.remove('active');
          });
          btn.classList.add('active');
          renderJobs();
        });
      });

      // Feed card button clicks (event delegation)
      document.getElementById('feedCards').addEventListener('click', function(e) {
        var btn = e.target.closest('[data-feed-id]');
        if (!btn) return;

        var feedId = btn.dataset.feedId;
        var action = btn.dataset.action;

        if (action === 'add') {
          addFeedToTracker(feedId);
        } else if (action === 'dismiss') {
          dismissFeedItem(feedId);
        }
      });

      // Refresh feed button
      document.getElementById('btnRefreshFeed').addEventListener('click', function() {
        loadFeed();
      });

      // Escape key closes modals
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          if (confirmOverlay.classList.contains('open')) {
            closeConfirm();
          } else if (modalOverlay.classList.contains('open')) {
            closeModal();
          }
        }
      });

      /* === Recruiter Event Listeners === */

      // Page tab switching (Jobs vs Recruiters)
      document.getElementById('pageTabs').addEventListener('click', function(e) {
        var tab = e.target.closest('.page-tab');
        if (!tab) return;
        switchPage(tab.dataset.page);
      });

      // Add recruiter form
      document.getElementById('recAddForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var company = document.getElementById('recCompanyInput').value.trim();
        if (!company) return;
        var contact = document.getElementById('recContactInput').value.trim();
        var status = document.getElementById('recStatusInput').value;
        addRecruiter({ company: company, contact: contact, status: status });
        document.getElementById('recAddForm').reset();
      });

      // Recruiter list event delegation (clicks on cards, flags, buttons)
      recList.addEventListener('click', function(e) {
        var target = e.target.closest('[data-rec-action]');
        if (!target) return;

        var action = target.dataset.recAction;
        var recId = target.dataset.recId;

        // Priority and follow-up flags should not trigger expand/collapse
        if (action === 'priority') {
          e.stopPropagation();
          toggleRecPriority(recId);
          return;
        }

        if (action === 'followup') {
          e.stopPropagation();
          toggleRecFollowUp(recId);
          return;
        }

        if (action === 'toggle') {
          toggleRecExpand(recId);
          return;
        }

        if (action === 'delete') {
          if (confirm('Remove this recruiter and all their roles?')) {
            deleteRecruiter(recId);
          }
          return;
        }

        if (action === 'delete-role') {
          var roleId = target.dataset.roleId;
          deleteRole(recId, roleId);
          return;
        }
      });

      // Add role form submission (delegated because forms are inside dynamically rendered cards)
      recList.addEventListener('submit', function(e) {
        var form = e.target.closest('[data-rec-action="add-role"]');
        if (!form) return;
        e.preventDefault();

        var recId = form.dataset.recId;
        var inputs = form.querySelectorAll('input, select');
        var title = inputs[0].value.trim();
        if (!title) return;

        var company = inputs[1].value.trim();
        var status = inputs[2].value;
        var comment = inputs[3].value.trim();

        addRole(recId, { title: title, company: company, status: status, comment: comment });
      });

      // Auto-save recruiter fields on blur (change event for selects, blur for text inputs)
      recList.addEventListener('change', function(e) {
        var el = e.target.closest('[data-rec-field]');
        if (!el) return;
        var recId = el.dataset.recId;
        var field = el.dataset.recField;
        var value = el.value;

        updateRecField(recId, field, value);

        // If status changed, we need to re-render to update the badge on the summary row
        if (field === 'status') {
          renderRecruiters();
        }
      });

      // Also auto-save text inputs and textareas on blur
      recList.addEventListener('blur', function(e) {
        var el = e.target.closest('[data-rec-field]');
        if (!el) return;
        // Skip selects (already handled by change)
        if (el.tagName === 'SELECT') return;
        var recId = el.dataset.recId;
        var field = el.dataset.recField;
        var value = el.value;

        updateRecField(recId, field, value);
      }, true); // use capture so blur fires for all descendants

    });
  </script>
</body>
</html>
